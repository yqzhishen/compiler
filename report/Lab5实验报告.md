# Lab 5 实验报告

#### 姓名：杨迁		学号：19231120



Lab 5 的主要内容是作用域和全局变量。此前实现的变量符号表是一个单纯的 HashMap，无法携带层次信息。因此本次将符号表改为栈式符号表：

```java
public class SymTable {
    private final Stack<Map<String, Symbol>> varTable = new Stack<>();
    public void pushLayer() {
        varTable.push(new HashMap<>());
    }
    public void popLayer() {
        varTable.pop();
    }
    // ...
}
```

在生成中间代码时，每当遇到语句块 Block，就调用`pushLayer()`方法压栈一层符号表，语句块结束时则调用`popLayer()`方法退栈一层符号表。遇到变量定义时，在符号栈最上层查找符号，如果遇到同名符号则报错，否则将其添加到最上层符号表中；遇到变量引用时，自栈顶向栈底逐层查找符号，遇到符号则代表找到定义，否则如果直到遍历完整个符号栈依然没有找到，则报错（符号未定义）。全局变量则存储在符号栈的最底层，这一层在编译开始，符号表对象初始化时就压入栈中。

除此以外全局变量/常量基本没有用到新的策略。全局变量/常量除了缺省初值为 0 以外，初始化采用之前局部常量的策略（即必须是编译时可求值的常量表达式），在编译时直接完成运算。将全局变量的初始值写进中间代码，全局常量则在编译期暂存于符号表中（连同其对应的值），被引用时直接用值替换，其本身不再在中间代码中出现。
