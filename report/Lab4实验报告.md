# Lab 4 实验报告

#### 姓名：杨迁		学号：19231120



Lab 4 的主要工作是实现条件表达式和`if-else`语句跳转。

条件表达式对于递归子程序来说就是在原有的加减法、乘除法基础上增加逻辑或和逻辑与运算，按照优先级的先后顺序，复刻加减法和乘除法的实现。但是由于四则运算与逻辑运算的差异，并且需要支持混用的情况（例如直接将四则运算结果或数字作为逻辑表达式），所以在语法分析的时候进行了一定的预处理，遇到将数值运算结果作为逻辑子表达式的情况时，将结果再套上一层`!=0`的逻辑运算，从而在顶层的逻辑运算中实现了一致性，即每一个逻辑子表达式一定是一个真正的逻辑表达式，可以直接用位运算取结果。

对于逻辑反`!`运算的处理，由于`!`运算是和`+`,`-`同级的，因此在分析表达式中的每一“项”时应该统计其前面的`+`,`-`和`!`号。如果`-`为奇数个，则按照此前实现的逻辑套上一层减法运算（`0 - x`），如果`!`为奇数个，则需要套上一层逻辑反运算。特殊情况是`!`号后跟着括号，这时候括号里面可能是四则运算表达式，也有可能是逻辑表达式，所以需要特殊处理一下：前面带`!`号的括号内按照逻辑表达式分析，其余情况保持不变，依然按照四则运算表达式分析，即分析起点不同。

除此以外需要注意的是代码生成时逻辑运算结果与数值运算结果的互相转换。由于语法分析中已经处理过一部分转换的情况（将数值结果套上`!=0`逻辑运算），所以逻辑表达式节点直接用`i1`运算就可以了，但由于逻辑反`!`运算依然会出现混用的情况，所以这里特判一下，如果取反的结果参与了数值运算，就将结果扩展为`i32`。

实现逻辑表达式以后`if-else`语句就相对很容易了，遇到`if`语句时先运算其条件，然后将其结果作为跳转条件，`if`块和`else`块（如果有的话）各自是一个基本块，各自运行结束后再跳转到`if`语句后的下一条语句。这里也有特殊情况，当`if`或`else`块中的最后一条语句是`return`的时候，直接生成 IR 就违反了基本块“最后有且只有一条跳转语句”的定义，会被 LLVM 报错，所以特判一下。但这里还是不能解决`if`和`else`块的都有`return`，但整个`if`语句后面没有`return`的情况（否则会导致最后一个基本块为空，也违反了基本块定义），测评样例似乎没有要求，所以忽略。
